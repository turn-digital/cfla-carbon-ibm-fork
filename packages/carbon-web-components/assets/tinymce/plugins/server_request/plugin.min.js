tinymce.PluginManager.add('server_request', function (editor) {
  var requestObject = window['config_' + editor.id].request_obj || null;
  var isModal = window['config_' + editor.id].isModal || false;
  var onServerLastEditor =
    window['config_' + editor.id].onServerLastEditor || null;

  if (!requestObject) {
    return;
  }

  function insertServerInfoHtml() {
    var validationElement = editor
      .getElement()
      .parentNode.querySelector('#length-validation-warning');
    var serverInfoHtml = `
      <div>
        <p style="color: grey" id="server-last-editor-${editor.id}">
          <span id="last-editor-name-${editor.id}">${
      onServerLastEditor?.name || ''
    }</span>
          <span id="last-editor-date-${editor.id}">${
      onServerLastEditor?.date || ''
    }</span>
        </p>
      </div>
    `;

    if (validationElement) {
      validationElement.insertAdjacentHTML('afterend', serverInfoHtml);
    }
  }

  function makePostRequest(requestObject, data) {
    editor.mode.set('readonly');

    fetch(requestObject.urlToRequest, {
      method: requestObject.requestMethod,
      headers: {
        'Content-Type': `application/json`,
        __RequestVerificationToken: `${requestObject.verificationToken}`,
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((result) => {
        editor.mode.set('design');
        editor.isNotDirty = true;

        var editorParentNode = editor.getElement().parentNode;
        editorParentNode.querySelector(
          `#last-editor-name-${editor.id}`
        ).textContent = result.userId;
        editorParentNode.querySelector(
          `#last-editor-date-${editor.id}`
        ).textContent = result.userId;

        // Show "Saved" after successful POST
        var savedElement = editor
          .getElement()
          .parentNode.querySelector(`#saved-${editor.id}`);
        savedElement.style.display = 'block';
      })
      .catch((error) => {
        editor.mode.set('design');
        editor.notificationManager.open({
          text: requestObject.errorAlertMessage || 'An error occurred.',
          type: 'error',
        });
      });
  }

  // Insert custom HTML on editor initialization
  editor.on('init', function () {
    insertServerInfoHtml(); // Initial placement of the server info HTML
  });

  editor.on('blur', function () {
    if (!editor.isNotDirty) {
      if (!isModal) {
        makePostRequest(requestObject, {
          [requestObject.requestValueKey]: editor.getContent({
            format: 'html',
          }),
        });
      }
    }
  });
});
