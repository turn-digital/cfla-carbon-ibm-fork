tinymce.PluginManager.add('server_request', function (editor) {
  var requestObject = window['config_' + editor.id].request_obj || null;
  var isModal = window['config_' + editor.id].isModal || false;

  if (!requestObject) {
    return;
  }

  function makePostRequest(requestObject, data) {
    editor.mode.set('readonly');

    fetch(requestObject.urlToRequest, {
      method: requestObject.requestMethod,
      headers: {
        'Content-Type': `application/json`,
        // prettier-ignore
        "__RequestVerificationToken": `${requestObject.verificationToken}`,
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((result) => {
        editor.mode.set('design');
        editor.isNotDirty = true;

        // Show "Saved" after successful POST
        var savedElement = editor
          .getElement()
          .parentNode.querySelector(`#saved-${editor.id}`);
        savedElement.style.display = 'block';
      })
      .catch((error) => {
        editor.mode.set('design');
        editor.notificationManager.open({
          text: requestObject.errorAlertMessage || 'An error occurred.',
          type: 'error',
        });
      });
  }

  // Insert custom HTML on editor initialization
  editor.on('blur', function () {
    if (!editor.isNotDirty) {
      if (!isModal) {
        makePostRequest(requestObject, {
          [requestObject.requestValueKey]: editor.getContent({
            format: 'html',
          }),
        });
      }
    }
  });
});
