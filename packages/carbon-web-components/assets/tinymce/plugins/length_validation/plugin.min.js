tinymce.PluginManager.add('length_validation', function (editor) {
  var maxCharLength = window['config_' + editor.id].max_length || '';
  var editorTitle = window['config_' + editor.id].editorTitle || '';
  var fetchObject = window['config_' + editor.id].fetch_obj || {};
  var isModal = window['config_' + editor.id].isModal || false;

  // Function to insert custom HTML before the editor
  function insertCustomHtml() {
    var currentCharsLength = editor.getContent({ format: 'text' }).length;
    var counterHtml = `<div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 400; padding: 0px 3px 6px 3px;"><p style="padding: 0; margin: 0;" id='editor-title-${editor.id}'>${editorTitle}</p><div style="display: flex;"><p id='saved-${editor.id}' style="display: none; margin: 0 10px 0 0 ">Saglabāts</p><p style="padding: 0; margin: 0;" id='content-length-${editor.id}'>${currentCharsLength}/${maxCharLength}</p></div></div>`;
    var textLengthValidationErrorMsgHtml = `<div id="length-validation-warning" style="color: red; display: none"><p>Pārsniegts maksimālais zīmju skaits, nodzēsiet pārsniegto tekstu</p></div>`;

    // Initial custom HTML
    var editorElement = editor.getElement();
    var textLengthValidationErrorMsgElement = editorElement.nextSibling;

    // Insert the custom HTML before the editor
    editorElement.insertAdjacentHTML('beforebegin', counterHtml);
    textLengthValidationErrorMsgElement.insertAdjacentHTML(
      'afterend',
      textLengthValidationErrorMsgHtml
    );
  }

  // Function to update chars length and background color based on character length
  function lengthValidation() {
    var currentCharsLength = editor.getContent({ format: 'text' }).length;
    var customElementId = `content-length-${editor.id}`;
    var customHtmlElement = editor
      .getElement()
      .parentNode.querySelector(`#${customElementId}`);

    var errorDivElement = editor
      .getElement()
      .parentNode.querySelector(`#length-validation-warning`);

    // Update the custom HTML with the current text length
    if (customHtmlElement) {
      customHtmlElement.innerHTML = `${currentCharsLength}/${maxCharLength}`;
    }

    // Change editor background color if more than maxCharLength
    if (maxCharLength) {
      if (currentCharsLength > maxCharLength) {
        editor.getBody().style.backgroundColor = '#FF7F7F';
        customHtmlElement.style.color = '#DA1E28';
        errorDivElement.style.display = 'block';
      } else {
        editor.getBody().style.backgroundColor = ''; // Reset to default
        customHtmlElement.style.color = 'black';
        errorDivElement.style.display = 'none';
      }
    }

    // Show "Saved" when not dirty
    var savedElement = editor
      .getElement()
      .parentNode.querySelector(`#saved-${editor.id}`);
    if (editor.isNotDirty) {
      savedElement.style.display = 'block';
    } else {
      savedElement.style.display = 'none';
    }
  }

  function makePostRequest(fetchObject, data) {
    editor.mode.set('readonly');

    fetch(fetchObject.urlToFetch, {
      method: fetchObject.fetchMethod,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((result) => {
        editor.mode.set('design');
        editor.isNotDirty = true;

        // Show "Saved" after successful POST
        var savedElement = editor
          .getElement()
          .parentNode.querySelector(`#saved-${editor.id}`);
        savedElement.style.display = 'block';
      })
      .catch((error) => {
        console.error('Error making POST request', error);
        editor.mode.set('design');
        editor.notificationManager.open({
          text: fetchObject.errorAlertMessages || 'An error occurred.',
          type: 'error',
        });
      });
  }

  // Event listener for keyup to update background color and content length
  editor.on('keyup', function () {
    var currentCharsLength = editor.getContent({ format: 'text' }).length;
    lengthValidation();

    // Hide "Saved" if there is content in the editor
    var savedElement = editor
      .getElement()
      .parentNode.querySelector(`#saved-${editor.id}`);
    if (currentCharsLength > 0) {
      savedElement.style.display = 'none';
    }
  });

  // Event listener for change to update dirty state
  editor.on('change', function () {
    var currentCharsLength = editor.getContent({ format: 'text' }).length;
    lengthValidation();

    // Hide "Saved" if the editor becomes dirty
    var savedElement = editor
      .getElement()
      .parentNode.querySelector(`#saved-${editor.id}`);
    if (!editor.isNotDirty || currentCharsLength > 0) {
      savedElement.style.display = 'none';
    }
    localStorage.setItem(
      `${editor.id}_content`,
      editor.getContent({ format: 'html' })
    );
  });

  // Insert custom HTML on editor initialization
  editor.on('init', function () {
    insertCustomHtml();
    lengthValidation(); // Update once on init to set the initial state
  });

  // Insert custom HTML on editor initialization
  editor.on('blur', function () {
    if (!editor.isNotDirty) {
      if (isModal) {
        // Store data in localStorage
        localStorage.setItem(
          `${editor.id}_content`,
          editor.getContent({ format: 'html' })
        );
      } else {
        makePostRequest(fetchObject, {
          text: editor.getContent({ format: 'html' }),
        });
      }
    }
  });
});
